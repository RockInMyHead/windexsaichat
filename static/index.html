<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WindexsAI - Искусственный интеллект нового поколения</title>
    <link rel="icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/style.css?v=20251027-01">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- KaTeX CSS для математических формул -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
</head>
<body>
    <div class="app">
        <!-- Auth Modal -->
        <div id="auth-modal" class="auth-modal">
            <div class="auth-container">
                <div class="auth-header text-center mb-6">
                    <div class="logo d-flex align-items-center justify-content-center gap-3 mb-4">
                        <img src="/static/round_logo-07.svg" alt="WindexsAI" width="32" height="32">
                        <h1 class="gradient-text">WIndexsAi</h1>
                    </div>
                    <p class="text-muted">Добро пожаловать в будущее искусственного интеллекта</p>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="auth-form">
                    <h2 class="text-center mb-4">Вход в систему</h2>
                    <form id="login-form-element">
                        <div class="form-group">
                            <label for="login-email" class="form-label">Email</label>
                            <input type="email" id="login-email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password" class="form-label">Пароль</label>
                            <input type="password" id="login-password" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Войти</button>
                    </form>
                    <p class="auth-switch">
                        Нет аккаунта? <a href="#" id="show-register" class="text-primary">Зарегистрироваться</a>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="auth-form hidden">
                    <h2 class="text-center mb-4">Регистрация</h2>
                    <form id="register-form-element">
                        <div class="form-group">
                            <label for="register-username" class="form-label">Имя пользователя</label>
                            <input type="text" id="register-username" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="register-email" class="form-label">Email</label>
                            <input type="email" id="register-email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password" class="form-label">Пароль</label>
                            <input type="password" id="register-password" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Зарегистрироваться</button>
                    </form>
                    <p class="auth-switch">
                        Уже есть аккаунт? <a href="#" id="show-login" class="text-primary">Войти</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Main App (hidden until authenticated) -->
        <div id="main-app" class="main-app hidden">
        <!-- Единый красивый хедер -->
        <header class="unified-header">
            <div class="header-container">
                <a href="/" class="header-logo">
                    <img src="/static/round_logo-07.svg" alt="WindexsAI" width="32" height="32">
                    <span class="logo-text">WindexsAI</span>
                </a>

                <nav class="header-nav">
                    <div class="nav-links">
                        <!-- <a href="/editor" class="nav-link">Создание сайтов</a> -->
                        <!-- <a href="/dashboard" class="nav-link">Кабинет</a> -->
                    </div>
                </nav>

                <div class="header-actions">
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <span class="user-name" id="user-name">Пользователь</span>
                    </div>
                </div>

                <!-- Мобильная кнопка меню в правом углу -->
                <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Открыть меню">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Sidebar Overlay для мобильных устройств -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="main-content d-flex">
            <!-- Sidebar -->
            <aside class="sidebar card" id="sidebar">
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <h3 class="mb-0">История чатов</h3>
                        <button id="clear-history-btn" class="btn btn-outline btn-sm">Очистить</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="conversations-list" class="conversations-list">
                        <!-- Conversations will be loaded here -->
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <section class="chat-area d-flex flex-column">
                <!-- Selected Model Info - Hidden -->
                <div id="selected-model" class="selected-model hidden" style="display: none !important;">
                    <div class="model-info">
                        <div class="model-icon" id="model-icon">L</div>
                        <div class="model-details">
                            <h4 id="model-name">WIndexsAi Lite</h4>
                            <p id="model-description">Быстрая и эффективная модель для повседневных задач</p>
                        </div>
                    </div>
                </div>

                <div id="chat-container" class="chat-container flex-grow-1">
                    <!-- Welcome Message -->
                    <div id="welcome-message" class="welcome-message text-center fade-in">
                        <div class="welcome-icon mb-4"></div>
                        <h2 class="gradient-text mb-3">Добро пожаловать в WIndexsAI</h2>
                        <p class="text-muted mb-5">Выберите модель для начала работы</p>

                        <!-- Classic Models Section -->
                        <div class="classic-models-section mb-5">
                            <h4 class="mb-3">Классические модели</h4>
                            <div class="model-cards d-flex gap-4 justify-content-center">
                                <div class="model-card card" data-model="gpt-4o-mini">
                                    <div class="card-body text-center">
                                        <h3 class="mb-3">WindexsAI Lite</h3>
                                        <p class="text-muted mb-4">Быстрая и эффективная модель для повседневных задач</p>
                                        <div class="capabilities d-flex flex-wrap gap-2 justify-content-center">
                                            <span class="capability btn btn-outline btn-sm">Текст</span>
                                            <span class="capability btn btn-outline btn-sm">Код</span>
                                            <span class="capability btn btn-outline btn-sm">Анализ</span>
                                            <span class="capability btn btn-outline btn-sm">Перевод</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="model-card card pro-model" data-model="gpt-4o">
                                    <div class="pro-badge">Подписка Pro</div>
                                    <div class="card-body text-center">
                                        <h3 class="mb-3">WindexsAI Pro</h3>
                                        <p class="text-muted mb-4">Продвинутая модель с расширенными возможностями</p>
                                        <div class="capabilities d-flex flex-wrap gap-2 justify-content-center">
                                            <span class="capability btn btn-outline btn-sm">Текст</span>
                                            <span class="capability btn btn-outline btn-sm">Код</span>
                                            <span class="capability btn btn-outline btn-sm">Анализ</span>
                                            <span class="capability btn btn-outline btn-sm">Перевод</span>
                                            <span class="capability btn btn-outline btn-sm">Креативность</span>
                                            <span class="capability btn btn-outline btn-sm">Логика</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4 class="mb-3">Специализированные AI-ассистенты</h4>
                        <p class="text-muted mb-4">Выберите специализированного AI-ассистента для ваших задач</p>

                        <!-- AI Specialists Gallery -->
                        <div class="ai-specialists-gallery">
                            <div class="specialists-container">
                                <button class="scroll-btn scroll-left" onclick="scrollSpecialists('left')">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="specialists-grid" id="specialistsGrid">
                                <!-- Ментор -->
                                <div class="specialist-card card" data-specialist="mentor" data-model="gpt-4o">
                                    <div class="card-body text-center">
                                        <div class="specialist-icon mb-3">🎓</div>
                                        <h3 class="mb-2">AI Ментор</h3>
                                        <p class="text-muted mb-3">Персональный наставник для развития навыков и карьеры</p>
                                        <div class="specialist-skills">
                                            <span class="skill-tag">Карьерное планирование</span>
                                            <span class="skill-tag">Обучение</span>
                                            <span class="skill-tag">Мотивация</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Психолог -->
                                <div class="specialist-card card" data-specialist="psychologist" data-model="gpt-4o">
                                    <div class="card-body text-center">
                                        <div class="specialist-icon mb-3">🧠</div>
                                        <h3 class="mb-2">AI Психолог</h3>
                                        <p class="text-muted mb-3">Поддержка психического здоровья и эмоционального благополучия</p>
                                        <div class="specialist-skills">
                                            <span class="skill-tag">Стресс-менеджмент</span>
                                            <span class="skill-tag">Эмоции</span>
                                            <span class="skill-tag">Саморазвитие</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Программист -->
                                <div class="specialist-card card" data-specialist="programmer" data-model="gpt-4o">
                                    <div class="card-body text-center">
                                        <div class="specialist-icon mb-3">💻</div>
                                        <h3 class="mb-2">AI Программист</h3>
                                        <p class="text-muted mb-3">Эксперт по разработке и техническим решениям</p>
                                        <div class="specialist-skills">
                                            <span class="skill-tag">Кодинг</span>
                                            <span class="skill-tag">Архитектура</span>
                                            <span class="skill-tag">Отладка</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Бухгалтер -->
                                <div class="specialist-card card" data-specialist="accountant" data-model="gpt-4o-mini">
                                    <div class="card-body text-center">
                                        <div class="specialist-icon mb-3">📊</div>
                                        <h3 class="mb-2">AI Бухгалтер</h3>
                                        <p class="text-muted mb-3">Финансовый консультант и эксперт по учету</p>
                                        <div class="specialist-skills">
                                            <span class="skill-tag">Финансы</span>
                                            <span class="skill-tag">Налоги</span>
                                            <span class="skill-tag">Отчетность</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Аналитик -->
                                <div class="specialist-card card" data-specialist="analyst" data-model="gpt-4o">
                                    <div class="card-body text-center">
                                        <div class="specialist-icon mb-3">📈</div>
                                        <h3 class="mb-2">AI Аналитик</h3>
                                        <p class="text-muted mb-3">Специалист по анализу данных и бизнес-процессов</p>
                                        <div class="specialist-skills">
                                            <span class="skill-tag">Анализ данных</span>
                                            <span class="skill-tag">Статистика</span>
                                            <span class="skill-tag">Прогнозирование</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Универсальный -->
                                <div class="specialist-card card" data-specialist="general" data-model="gpt-4o-mini">
                                    <div class="card-body text-center">
                                        <div class="specialist-icon mb-3"></div>
                                        <h3 class="mb-2">Универсальный AI</h3>
                                        <p class="text-muted mb-3">Многофункциональный помощник для любых задач</p>
                                        <div class="specialist-skills">
                                            <span class="skill-tag">Общие вопросы</span>
                                            <span class="skill-tag">Творчество</span>
                                            <span class="skill-tag">Помощь</span>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <button class="scroll-btn scroll-right" onclick="scrollSpecialists('right')">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chat-messages" class="chat-messages hidden">
                        <!-- Messages will be added here dynamically -->
                    </div>


                    <!-- Document Upload Indicator -->
                    <div id="document-upload-indicator" class="document-upload-indicator hidden">
                        <div class="upload-content">
                            <div class="upload-icon">📄</div>
                            <div class="upload-text">Обработка документа...</div>
                            <div class="upload-progress">
                                <div class="progress-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-area card">
                    <div class="card-body">
                        <div class="input-container d-flex align-items-end gap-3">
                            <textarea
                                id="message-input"
                                class="form-input flex-grow-1"
                                placeholder="Введите ваше сообщение..."
                                rows="1"
                                maxlength="12000"
                            ></textarea>
                            <input type="file" id="document-input" accept=".pdf,.docx,.doc,.txt,.csv,.rtf,.jpg,.jpeg,.png,.gif,.bmp,.tiff" style="display: none;">
                            
                            <!-- Кнопка с выдвижным меню -->
                            <div class="dropdown-menu-container" style="position: relative !important; display: inline-block !important;">
                                <button id="tools-btn" class="btn btn-outline" title="Инструменты" style="position: relative; z-index: 100;">
                                    <span class="tools-text">Инструменты</span>
                                    <span class="tools-icon">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14.7 6.3a1 1 0 0 0-1.4 0L10 9.58 8.7 8.3a1 1 0 0 0-1.4 0 1 1 0 0 0 0 1.4l2 2a1 1 0 0 0 1.4 0l4-4a1 1 0 0 0 0-1.4Z"></path>
                                            <path d="M14.7 12.3a1 1 0 0 0-1.4 0L10 15.58 8.7 14.3a1 1 0 0 0-1.4 0 1 1 0 0 0 0 1.4l2 2a1 1 0 0 0 1.4 0l4-4a1 1 0 0 0 0-1.4Z"></path>
                                            <path d="M20 4v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2Z"></path>
                                        </svg>
                                    </span>
                                </button>

                                <div id="tools-dropdown" class="tools-dropdown">
                                    <button id="document-btn" class="dropdown-item" onclick="handleDocument()" style="display: flex !important; align-items: center !important; gap: 10px !important; width: 100% !important; padding: 12px 16px !important; border: none !important; background: none !important; color: #333 !important; font-size: 14px !important; text-align: left !important; cursor: pointer !important; border-bottom: 1px solid #eee !important;">
                                        Документ
                            </button>

                                    <button id="connect-btn" class="dropdown-item" onclick="handleConnect()" style="display: flex !important; align-items: center !important; gap: 10px !important; width: 100% !important; padding: 12px 16px !important; border: none !important; background: none !important; color: #333 !important; font-size: 14px !important; text-align: left !important; cursor: pointer !important;">
                                        Подключение к облаку
                            </button>
                                </div>
                            </div>
                            
                            <!-- Voice Button -->
                            <button id="voice-btn" class="btn btn-outline" title="Голосовое сообщение">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="22"></line>
                                    <line x1="8" y1="22" x2="16" y2="22"></line>
                                </svg>
                            </button>
                            <button id="send-btn" class="btn btn-primary btn-sm" disabled>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                                </svg>
                            </button>
                        </div>
                        <div class="input-footer d-flex justify-content-between align-items-center mt-2">
                            <span class="char-count text-muted">0/12000</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading-content text-center">
                <div class="loading-spinner mb-4"></div>
                <h3 class="gradient-text">WindexsAI думает...</h3>
                <p class="text-muted">Пожалуйста, подождите</p>
            </div>
        </div>
        </div>
        </div>
    </div>


    <!-- Connect Modal -->
    <div id="connect-modal" class="connect-modal hidden">
        <div class="connect-modal-content card">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                    <h2 class="mb-0">☁️ Подключение к облаку</h2>
                    <button class="close-connect btn btn-outline" title="Закрыть">×</button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <p class="text-muted mb-3">Введите учетные данные для доступа к облачному сервису:</p>
                    <div class="form-group mb-3">
                        <label for="connection-username" class="form-label">Имя пользователя</label>
                        <input
                            type="text"
                            id="connection-username"
                            class="form-control"
                            placeholder="Введите имя пользователя..."
                            value="admin"
                        >
                    </div>
                    <div class="form-group">
                        <label for="connection-password" class="form-label">Пароль</label>
                        <input
                            type="password"
                            id="connection-password"
                            class="form-control"
                            placeholder="Введите пароль..."
                            value="admin123"
                        >
                    </div>
                    <div class="mt-3">
                        <p class="text-muted small mb-2">Нет аккаунта в облаке?</p>
                        <a href="https://cloud.windexai.com/register" target="_blank" class="btn btn-outline btn-sm">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            </svg>
                            Зарегистрироваться в облаке
                        </a>
                    </div>
                </div>

                <div class="connection-status mb-4" id="connection-status" style="display: none;">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Проверка подключения...</span>
                        </div>
                    </div>
                </div>

                <div class="connection-result mb-4" id="connection-result" style="display: none;">
                    <!-- Результат проверки подключения -->
                </div>

                <div class="d-flex gap-3">
                    <button id="test-connection-btn" class="btn btn-primary flex-fill">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22,4 12,14.01 9,11.01"></polyline>
                        </svg>
                        Проверить подключение к облаку
                    </button>
                    <button id="connect-btn-modal" class="btn btn-success flex-fill" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                        Подключиться к облаку
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agreement Modal -->
    <div id="agreement-modal" class="modal hidden">
      <div class="modal-overlay" id="agreement-overlay"></div>
      <div class="modal-content">
        <button class="modal-close" id="agreement-close">&times;</button>
        <h2>Пользовательское соглашение</h2>
        <div class="modal-body">
          <p>1. Общие положения</p>
          <p>Настоящее Пользовательское соглашение (далее – Соглашение) является договором между Пользователем и компанией-владельцем сервиса WIndexsAI (далее – Сервис). Используя Сервис, вы соглашаетесь с условиями этого Соглашения.</p>
          <p>2. Определения</p>
          <p>«Пользователь» – физическое или юридическое лицо, использующее Сервис. «Контент» – информация, размещаемая или генерируемая через Сервис.</p>
          <p>3. Регистрация и аккаунт</p>
          <p>Для использования функционала Сервиса необходимо зарегистрироваться и создать аккаунт. Вы несете ответственность за сохранность логина и пароля и обязуетесь не передавать их третьим лицам.</p>
          <p>4. Права и обязанности Пользователя</p>
          <ul>
            <li>Пользователь вправе использовать Сервис для личных и коммерческих целей согласно функционалу.</li>
            <li>Пользователь обязуется использовать Сервис добросовестно и не нарушать действующее законодательство.</li>
          </ul>
          <p>5. Запрещенные действия</p>
          <ul>
            <li>Не допускается распространение вирусов, спама, фишинга и других вредоносных материалов.</li>
            <li>Запрещается нарушать права третьих лиц, включая авторские права и право на конфиденциальность.</li>
          </ul>
          <p>6. Интеллектуальная собственность</p>
          <p>Все права на программный код, дизайн и контент, предоставляемый Сервисом, принадлежат его правообладателям. Пользователь получает лишь неисключительное право использования.</p>
          <p>7. Обработка персональных данных</p>
          <p>Сбор и обработка персональных данных осуществляется в соответствии с Политикой конфиденциальности, доступной на сайте.</p>
          <p>8. Ответственность сторон</p>
          <p>Сервис не несет ответственности за непрерывность работы и возможные технические сбои. Пользователь несет ответственность за сохранение данных и конфиденциальность.</p>
          <p>9. Изменение условий</p>
          <p>Сервис оставляет за собой право изменять условия Соглашения. Об изменениях Пользователь будет уведомлен на сайте или по электронной почте.</p>
          <p>10. Прекращение действия</p>
          <p>Соглашение действует до момента удаления аккаунта Пользователя или прекращения работы Сервиса.</p>
          <p>11. Применимое право и юрисдикция</p>
          <p>Настоящее Соглашение регулируется законодательством юрисдикции компании-владельца Сервиса. Все споры разрешаются в суде по месту нахождения правообладателя.</p>
          <p>12. Контактная информация</p>
          <p>По вопросам Соглашения обращайтесь: support@windexsai.com.</p>
        </div>
      </div>
    </div>

    <script src="/static/script.js?v=20251027-14"></script>
    <script src="/static/cloud-api.js"></script>

    <!-- KaTeX для математических формул -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Mermaid.js для диаграмм -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.esm.min.mjs';

        // Настройка Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Inter, sans-serif',
            fontSize: 14,
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // Функция для рендеринга диаграмм
        window.renderDiagrams = async function() {
            // Обрабатываем Mermaid диаграммы
            const mermaidElements = document.querySelectorAll('.mermaid');
            for (const element of mermaidElements) {
                if (element.getAttribute('data-processed') === 'true') continue;

                try {
                    const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                    element.id = id;
                    element.setAttribute('data-processed', 'true');

                    const { svg } = await mermaid.render(id, element.textContent);
                    element.innerHTML = svg;
                } catch (error) {
                    console.error('Ошибка рендеринга Mermaid диаграммы:', error);
                    element.innerHTML = '<div class="mermaid-error">Ошибка при рендеринге диаграммы Mermaid</div>';
                }
            }

            // Обрабатываем текстовые диаграммы (ASCII art)
            const textDiagrams = document.querySelectorAll('.diagram-content');
            for (const element of textDiagrams) {
                if (element.getAttribute('data-processed') === 'true') continue;

                try {
                    element.setAttribute('data-processed', 'true');
                    // Добавляем красивые стили для текстовых диаграмм
                    element.style.fontFamily = 'JetBrains Mono, Fira Code, Monaco, Courier New, monospace';
                    element.style.lineHeight = '1.5';
                    element.style.letterSpacing = '0.5px';
                } catch (error) {
                    console.error('Ошибка обработки текстовой диаграммы:', error);
                }
            }
        };

        // Автоматический рендеринг при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                window.renderDiagrams();
            }, 100);
        });

        // MutationObserver для динамически добавляемого контента
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    setTimeout(() => {
                        window.renderDiagrams();
                    }, 100);
                }
            });
        });

        observer.observe(document.getElementById('chat-messages'), {
            childList: true,
            subtree: true
        });
    </script>

    <!-- KaTeX авто-рендеринг математических выражений -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\[", right: "\\]", display: true},
                    {left: "\\(", right: "\\)", display: false}
                ],
                throwOnError: false,
                errorColor: '#cc0000',
                strict: 'warn',
                trust: true
            });
        });

        // Функция для повторного рендеринга после добавления новых сообщений
        function renderMathInChat() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages && typeof renderMathInElement !== 'undefined') {
                renderMathInElement(chatMessages, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\[", right: "\\]", display: true},
                        {left: "\\(", right: "\\)", display: false}
                    ],
                    throwOnError: false,
                    errorColor: '#cc0000',
                    strict: 'warn',
                    trust: true
                });
            }
        }
    </script>
</body>
</html>
